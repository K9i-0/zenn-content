---
title: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸ã‚“ã ç”»åƒã‹ã‚‰Flutterã‚¢ãƒ—ãƒªã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸ã¶"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["flutter", "materialdesign", "riverpod"]
published: true
---
## ã¯ã˜ã‚ã«

Dynamic Colorã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
Dynamic Colorï¼ˆãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚«ãƒ©ãƒ¼ï¼‰ã¯ã€GoogleãŒææ¡ˆã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹Material Designã®ä¸€éƒ¨ã§ã™ã€‚ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚«ãƒ©ãƒ¼ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã‚„ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šã«åˆã‚ã›ã¦å‹•çš„ã«å¤‰åŒ–ã•ã›ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå€‹åˆ¥ã®å¥½ã¿ã‚„æ¡ä»¶ã«å¿œã˜ã¦æœ€é©ãªã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚by GPT4

ã“ã®è¨˜äº‹ã§ã¯Dynamic Colorã®ä»•çµ„ã¿ã‚’ä½¿ã£ã¦ã€ç”»åƒã‹ã‚‰è‰²ã‚’æŠ½å‡ºã—Flutterã‚¢ãƒ—ãƒªã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«åæ˜ ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªãŒä½œã‚Œã¾ã™ã€‚

![dynamic_color_gallery](/images/dynamic_color_gallery.gif =500x)

## material_color_utilitiesãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

Dynamic Colorã®ä»•çµ„ã¿ã¯è¤‡é›‘ã§ã™ãŒã€material_color_utilitiesãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…ãŒã‚ã‚‹ãŸã‚ã€ã“ã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã§ç°¡å˜ã«ç”»åƒã‹ã‚‰è‰²ã®æŠ½å‡ºãŒã§ãã¾ã™ã€‚

### ImageUtilsã‚’å®Ÿè£…

ã¾ãšã¯material_color_utilitiesã‚’ä½¿ã£ã¦ç”»åƒã‹ã‚‰è‰²ã‚’æŠ½å‡ºã™ã‚‹å®Ÿè£…ã‚’ã—ã¾ã™ã€‚

```dart:image_utils.dart
import 'package:flutter/material.dart' as material;
import 'package:image/image.dart';
import 'package:material_color_utilities/material_color_utilities.dart';
import 'package:material_color_utilities/utils/color_utils.dart';

class ImageUtils {
  /// ä¸Šä½4ã¤ã®è‰²ã‚’è¿”ã™
  static Future<List<material.Color>> sourceColorsFromImage(Image image) async {
    // å‡¦ç†ã‚’è»½ãã™ã‚‹ãŸã‚ã«ãƒªã‚µã‚¤ã‚ºï¼ˆå½“ç„¶çµæœãŒå¤‰ã‚ã‚‹ã®ã§æ³¨æ„ï¼‰
    final resizedImage = copyResize(image, width: 512, height: 512);

    // ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã®argbå½¢å¼ã®intã®ãƒªã‚¹ãƒˆ
    List<int> pixels = [];

    for (int y = 0; y < resizedImage.height; y++) {
      for (int x = 0; x < resizedImage.width; x++) {
        // ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«ã®è‰²ã‚’å–å¾—
        final pixel = resizedImage.getPixel(x, y);

        pixels.add(
          ColorUtils.argbFromRgb(
            pixel.r.toInt(),
            pixel.g.toInt(),
            pixel.b.toInt(),
          ),
        );
      }
    }

    // ã‚»ãƒ¬ãƒ“ã‚£ã•ã‚“è€ƒæ¡ˆã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§é‡å­åŒ–
    final quantizerResult = await QuantizerCelebi().quantize(pixels, 128);
    // é‡å­åŒ–ã—ãŸè‰²ã®ãƒªã‚¹ãƒˆã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
    final ranked = Score.score(quantizerResult.colorToCount);

    // ã‚¹ã‚³ã‚¢ã®é«˜ã„4è‰²ã‚’è¿”ã™
    return ranked
        .take(4)
        .map(
          (colorInt) => material.Color(colorInt),
        )
        .toList();
  }
}
```text

### ç°¡å˜ãªè§£èª¬

ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šãªã®ã§ã™ãŒã€ä¸€å¿œç°¡å˜ãªè§£èª¬ã§ã™ã€‚

sourceColorsFromImageã¯ç”»åƒã‚’å¼•æ•°ã«ã¨ã£ã¦ã€æŠ½å‡ºã—ãŸä¸Šä½4è‰²ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ä»¥ä¸‹ã®å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚

1. copyResizeã¯çµæ§‹å‡¦ç†ãŒé‡ã‹ã£ãŸã®ã§ã€ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ã„ã¾ã™ã€‚
2. ç”»åƒã‚’ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«argbå½¢å¼ã®intã«ã—ãŸListã‚’ä½œã‚‹
3. QuantizerCelebiã‚¯ãƒ©ã‚¹ã®quantizeã‚’ä½¿ã£ã¦è‰²æ•°ã‚’çµã‚‹
4. Scoreã‚¯ãƒ©ã‚¹ã®scoreã‚’ä½¿ã£ã¦ä¸Šä½ã‚’è‰²ã‚’æ±ºã‚ã‚‹
5. ä¸Šä½4ã¤ã®è‰²ã‚’è¿”ã™

### è£œè¶³

material_color_utilitiesã®Readmeã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã™ãŒã€ç«¯æœ«ã§è¨­å®šã•ã‚ŒãŸè‰²ã‚’ä½¿ã„ãŸã„ã ã‘ãªã‚‰ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ã€‚
<https://pub.dev/packages/dynamic_color>

### è£œè¶³2

material_color_utilitiesã¯flutterã®ä»¥ä¸‹ã®éƒ¨åˆ†ã§ä½¿ã‚ã‚Œã¦ãŸã‚Šã‚‚ã—ã¾ã™ã€‚SeedColorã‹ã‚‰Schemeã‚’ä½œã‚‹ã¨ã“ã‚ã§ã™ã­ğŸ‘€
<https://github.com/flutter/flutter/blob/4c25587b71aa91e27c115893f59b48b8b4a22ca9/packages/flutter/lib/src/material/color_scheme.dart#L201-L209>

## å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã«åæ˜ ã™ã‚‹

å…ˆç¨‹ä½œã£ãŸImageUtilsã‚’å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ä½¿ã£ã¦ã¿ã¾ã™ã€‚å†’é ­ã®å‹•ç”»ã®ã‚¢ãƒ—ãƒªã§ã™ã€‚
ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹ã¨é•·ã„ã®ã§ä¸€éƒ¨ã‚’æŠœç²‹ã—ã¾ã™ã€‚

### Notifierã®å®Ÿè£…

ç”»åƒã¨è‰²ã‚’ã¾ã¨ã‚ã¦ãƒ¢ãƒ‡ãƒ«ã®ãƒªã‚¹ãƒˆã‚’æŒã¤NotifierProviderã®å®Ÿè£…ã§ã™ã€‚
è‰²æŠ½å‡ºå‡¦ç†ã¯é‡ã„ã®ã§ã€computeã‚’ä½¿ã£ã¦åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

```dart
@riverpod
class ImageAndColorsList extends _$ImageAndColorsList {
  @override
  Future<List<ImageAndColors>> build() {
    final defaultImageAssets = [
      'assets/image_1.jpg',
      'assets/image_2.jpg',
      'assets/image_3.jpg',
      'assets/image_4.jpg',
    ];
    final defaultImages = Future.wait(
      defaultImageAssets.map((asset) async {
        final bytes = await rootBundle.load(asset);
        final decoded = image.decodeImage(bytes.buffer.asUint8List());
        // å‡¦ç†ãŒé‡ã„ã®ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
        final colors =
            await compute(ImageUtils.sourceColorsFromImage, decoded!);
        return ImageAndColors(
          image: AssetImage(asset),
          colors: colors,
        );
      }),
    );
    return defaultImages;
  }

  Future<void> addImage(XFile imageFile) async {
    final file = File(imageFile.path);
    final bytes = await file.readAsBytes();

    final decoded = image.decodeImage(bytes);
    // å‡¦ç†ãŒé‡ã„ã®ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
    final colors = await compute(ImageUtils.sourceColorsFromImage, decoded!);
    update(
      (current) => [
        ...current,
        ImageAndColors(
          image: FileImage(file),
          colors: colors,
        ),
      ],
    );
  }
}
```text

### MaterialAppã®å®Ÿè£…

MaterialAppã®å®Ÿè£…ã§ã™ã€‚
colorSchemeSeedã‚’Notifierã®Stateã‚’watchã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å‹•çš„ã«å¤‰æ›´å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

```dart
@riverpod
class ColorSchemeSeed extends _$ColorSchemeSeed {
  @override
  Color build() {
    return Colors.blue;
  }

  void changeColor(Color color) {
    state = color;
  }
}

class MyApp extends ConsumerWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return MaterialApp(
      title: 'Material Color Utilities Demo',
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: ref.watch(colorSchemeSeedProvider),
      ),
      darkTheme: ThemeData(
        brightness: Brightness.dark,
        useMaterial3: true,
        colorSchemeSeed: ref.watch(colorSchemeSeedProvider),
      ),
      themeMode: ref.watch(themeModeStateProvider),
      home: const GalleryPage(),
    );
  }
}
```

## ã¾ã¨ã‚

ç”»åƒã®è‰²ã‚’æŠ½å‡ºã—ã¦ã‚¢ãƒ—ãƒªã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¤‰ãˆã‚‹æ–¹æ³•ã®ç´¹ä»‹ã§ã—ãŸã€‚
ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ä»¥å¤–ã«ã‚‚UIã®ä¸€éƒ¨ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã£ãŸè‰²ã«å¤‰ãˆãŸã‚Šå‡ºæ¥ã‚‹ã®ã§ã€æ°—ã«å…¥ã£ãŸã‚‰æ˜¯éè©¦ã—ã¦ã¿ãŸãã ã•ã„ã€‚

ä»¥ä¸‹ã¯ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®å®Ÿè£…ã§ã™ã€‚â­ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ¥³

<https://github.com/K9i-0/flutter_mcu_sample>

## ãŠã™ã™ã‚

Dynamic Colorã®ä»•çµ„ã¿ã‚’çŸ¥ã‚ŠãŸã„äººå‘ã‘
<https://blog.smartbank.co.jp/entry/2022/10/06/dynamic-color>

ãƒ‡ã‚¶ã‚¤ãƒ³è¦–ç‚¹ã®è©±
<https://note.com/ritar/n/n0f6aad6c2560>
