---
title: "Flutterã‚¢ãƒ—ãƒªã«ChatGPT APIã‚’çµ„ã¿è¾¼ã‚“ã§ã¿ãŸ"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["flutter", "chatgpt", "openai", "gpt3", "riverpod"]
published: true
publication_name: "toridori"
---
## ã¯ã˜ã‚ã«
ChatGPTä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿè‡ªåˆ†ã¯ã•ã£ããChatGPT Plusã‚’å¥‘ç´„ã—ã¦ã—ã¾ã„ã¾ã—ãŸğŸ’¸

è©±é¡Œã®ChatGPTã§ã™ãŒ3/2ã«APIãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚
ä»Šå›ã¯Flutterã‹ã‚‰ChatGPT APIã‚’åˆ©ç”¨ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
https://twitter.com/gdb/status/1630991925984755714?s=20

### ChatGPTã¨ã¯ï¼Ÿ
OpenAIãŒå…¬é–‹ã—ã¦ã„ã‚‹ãƒã‚§ãƒƒãƒˆç”¨ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«

![](/images/SCR-20230304-qi5.png)


## å®Ÿè·µ

### Flutterã‹ã‚‰ChatGPT APIã‚’åˆ©ç”¨ã™ã‚‹
OpenAIã®å…¬é–‹ã—ã¦ã„ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã®ã§ã€httpãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„dioãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦å©ãã“ã¨ãŒã§ãã¾ã™ã€‚

https://platform.openai.com/docs/api-reference/chat

ã¾ãŸã€éå…¬å¼ã§ã™ãŒ[dart_openai](https://pub.dev/packages/dart_openai)ã¨ã„ã†ã€OpenAIã®å…¬é–‹ã—ã¦ã„ã‚‹APIã‚’dartã‹ã‚‰ç°¡å˜ã«æ‰±ãˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ã€‚
æ›´æ–°é »åº¦é«˜ãè‰¯ã•ãã†ãªã®ã¨ã€è‡ªå‰ã§ãƒ¢ãƒ‡ãƒ«å®šç¾©ã™ã‚‹ã‚ˆã‚Šæ¥½ãã†ã ã£ãŸã®ã§ã€ä»Šå›ã¯ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚

### API Keyã‚’å–å¾—ã™ã‚‹
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚­ãƒ¼ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚ï¼ˆåˆå›ã¯ç™»éŒ²ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰
https://platform.openai.com/account/api-keys

### dart_openaiã‚’ä½¿ã†æº–å‚™
mainã§OpenAI.apiKeyã«å…ˆç¨‹å–å¾—ã—ãŸã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã™

```dart
import 'package:dart_openai/openai.dart';

void main() {
  OpenAI.apiKey = ã‚­ãƒ¼;
  runApp(const MainApp());
}
```

ã‚­ãƒ¼ã¯ç§˜åŒ¿æƒ…å ±ãªã®ã§[flutter_dotenv](https://pub.dev/packages/flutter_dotenv)ãªã©ã‚’ä½¿ã£ã¦ã€publicãƒªãƒã‚¸ãƒˆãƒªç­‰ã§å…¬é–‹ã—ãªã„ã‚ˆã†æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã¯è‡ªåˆ†ãŒã‚­ãƒ¼ã®è¨­å®šã‚’å®Ÿè£…ã—ãŸã¨ãã®ã‚³ãƒŸãƒƒãƒˆã§ã™ã€‚
https://github.com/K9i-0/flutter_chatgpt_sample/commit/2a558db3b716f8fd0756695b1ef18bb0326172a3

:::message
OpenAIã®APIã¯ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ–‡å­—æ•°ã®ã‚ˆã†ãªã‚‚ã®ï¼‰ã”ã¨ã®å¾“é‡èª²é‡‘ã§ã€ã‚­ãƒ¼ãŒæµå‡ºã™ã‚‹ã¨å±é™ºã§ã™ã€‚ã‚¹ãƒˆã‚¢ã«ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã™ã‚‹éš›ã¯ã€è‡ªå‰ã‚µãƒ¼ãƒãƒ¼ã”ã—ã«APIã‚’å©ãªã©ã—ã¦ã€ã‚¢ãƒ—ãƒªã«ã¯.envã§ã‚ã£ã¦ã‚‚ã‚­ãƒ¼ã‚’æŒãŸã›ãªã„ã»ã†ãŒè‰¯ã„ã§ã™ã€‚
:::

### ChatGPT APIã®ã–ã£ãã‚Šã¨ã—ãŸä»•çµ„ã¿
ChatGPT APIã¯ãƒ¢ãƒ‡ãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’æŒ‡å®šã—ã¦APIã‚’å©ãã¾ã™ã€‚

#### ãƒ¢ãƒ‡ãƒ«
GPTã®ãƒ¢ãƒ‡ãƒ«ã§ã™ã€ç¾çŠ¶gpt-3.5-turboã‚’è¨­å®šã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆ
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ­ãƒ¼ãƒ«ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆ¥ã‚Œã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚
ãƒ­ãƒ¼ãƒ«ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡è€…ã«ç›¸å½“ã—ã€assistant, user, systemã®ï¼“ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚
- assistant ChatGPTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- user äººé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- system èª¿æ•´ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

è¤‡æ•°å›ã®ã‚„ã‚Šã¨ã‚Šã‚’è¡Œã†ã¨ãã€ã“ã‚Œã¾ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å«ã‚ã¦APIã‚’å©ãã“ã¨ã§ã€æ–‡è„ˆã‚’è¸ã¾ãˆãŸå›ç­”ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚
èª¿æ•´ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Œã‚ãªãŸã¯ãƒªãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€ãªã©ã€ä¼šè©±ã®å‰æã‚’è¨­å®šã™ã‚‹ã®ã«ä½¿ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã¯UIã«ã¯è¡¨ç¤ºã—ãªã„ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

ä»–ã«ã‚‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ã‚ã‚‹ã®ã§ã€è©³ã—ãã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://platform.openai.com/docs/api-reference/chat

### dart_openaiã§ChatGPT APIã‚’å©ã
OpenAI.instance.chat.createã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å©ã‘ã°ã‚ˆã„ã§ã™ã€‚

å…ˆã»ã©èª¬æ˜ã—ãŸãƒ¢ãƒ‡ãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
```dart
OpenAIChatCompletionModel chatCompletion = await OpenAI.instance.chat.create(
    model: "gpt-3.5-turbo",
    messages: [
      OpenAIChatCompletionChoiceMessageModel(
            content: "hello, what is Flutter and Dart ?",
            role: "user",
        ),
    ],
);
```

### ãƒãƒ£ãƒƒãƒˆUIä½œã£ã¦ã¿ãŸ
ãŠãªã˜ã¿ã®riverpodã‚’ä½¿ã£ã¦ç”»é¢ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

#### Providerå®Ÿè£…
riverpodã‚’ä½¿ã£ã¦ã€ChatGPTã¨ã‚„ã‚Šã¨ã‚Šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’çŠ¶æ…‹ã«ã‚‚ã¡ã€æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã‚‹NotifierProviderã‚’ä½œã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã€å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¨è§£èª¬ã§ã™ã€‚

åˆæœŸåŒ–æ™‚ã¯ç©ºã®ãƒªã‚¹ãƒˆã«ã—ã¦ã„ã¾ã™ã€‚systemãƒ­ãƒ¼ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

sendMessageã§ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
1. æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã‚‹
2. stateã«1ã§ä½œã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åæ˜ ï¼ˆChatGPTå¾…ã¡ã®å‰ã«ã€UIã«é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åæ˜ ã™ã‚‹ï¼‰
3. APIã‚’å©ã
4. çµæœã‚’stateã«åæ˜ 

```dart
@riverpod
class Messages extends _$Messages {
  @override
  List<OpenAIChatCompletionChoiceMessageModel> build() => [];

  Future<void> sendMessage(String message) async {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’userãƒ­ãƒ¼ãƒ«ã§ãƒ¢ãƒ‡ãƒ«åŒ–
    final newUserMessage = OpenAIChatCompletionChoiceMessageModel(
      content: message,
      role: 'user',
    );
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    state = [
      ...state,
      newUserMessage,
    ];
    // ChatGPTã«èã
    final chatCompletion = await OpenAI.instance.chat.create(
      model: 'gpt-3.5-turbo',
      // ã“ã‚Œã¾ã§ã®ã‚„ã‚Šã¨ã‚Šã‚’å«ã‚ã¦é€ä¿¡
      messages: state,
    );
    // çµæœã‚’è¿½åŠ 
    state = [
      ...state,
      chatCompletion.choices.first.message,
    ];
  }
}
```

#### Widgetå®Ÿè£…
å…ˆç¨‹ã®Providerã‚’ä½¿ã†Widgetã‚’ä½œã‚Šã¾ã™ã€‚

ã–ã£ãã‚Šä»•æ§˜

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºéƒ¨
  - ChatGPTã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹
  - ChatGPTã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²ã‚’å¤‰ãˆã‚‹
  - systemã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„
- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
  - å…¥åŠ›ãŒã‚ã‚Œã°é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹
  - ChatGPTå¾…ã¡ä¸­ã¯ã€é€ä¿¡ãƒœã‚¿ãƒ³ã®ä»£ã‚ã‚Šã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹
```dart

class HomeScreen extends HookConsumerWidget {
  const HomeScreen({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final messages = ref.watch(messagesProvider);
    final messageController = useTextEditingController(text: 'Flutterã¨ã¯ãªã‚“ã§ã™ã‹ï¼Ÿ');
    final screenWidth = MediaQuery.of(context).size.width;
    final isWaiting = useState(false);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ChatGPT Sample'),
      ),
      body: SafeArea(
        child: Column(
          children: [
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
            Expanded(
              child: ListView.separated(
                keyboardDismissBehavior:
                    ScrollViewKeyboardDismissBehavior.onDrag,
                padding: const EdgeInsets.symmetric(horizontal: 16),
                itemCount: messages.length,
                itemBuilder: (context, index) {
                  final message = messages[index];
                  // systemãƒ­ãƒ¼ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„
                  if (message.role == 'system') {
                    return const SizedBox();
                  }

                  return Align(
                    key: Key(message.hashCode.toString()),
                    alignment: message.role == 'user'
                        ? Alignment.centerRight
                        : Alignment.centerLeft,
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        maxWidth: screenWidth * 0.8,
                      ),
                      child: DecoratedBox(
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(8),
                          color: message.role == 'user'
                              ? context.colorScheme.primary
                              : context.colorScheme.secondary,
                        ),
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            vertical: 8,
                            horizontal: 16,
                          ),
                          child: Text(
                            message.content,
                            style: TextStyle(
                              color: message.role == 'user'
                                  ? context.colorScheme.onPrimary
                                  : context.colorScheme.onSecondary,
                            ),
                          ),
                        ),
                      ),
                    ),
                  );
                },
                separatorBuilder: (context, index) =>
                    const SizedBox(height: 16),
              ),
            ),
            // é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ 
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: DecoratedBox(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: context.colorScheme.primary,
                    width: 2,
                  ),
                ),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    Expanded(
                      child: TextField(
                        controller: messageController,
                        maxLines: null,
                        decoration: InputDecoration(
                          hintText: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›',
                          hintStyle: TextStyle(
                            color: Theme.of(context)
                                .colorScheme
                                .onBackground
                                .withOpacity(0.6),
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            vertical: 12,
                            horizontal: 16,
                          ),
                          border: InputBorder.none,
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    // é€ä¿¡ãƒœã‚¿ãƒ³
                    if (!isWaiting.value)
                      IconButton(
                        onPressed: () async {
                          if (messageController.text.isEmpty) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
                              ),
                            );
                          } else {
                            final sendMessage =
                                ref.read(messagesProvider.notifier).sendMessage(
                                      messageController.text,
                                    );
                            isWaiting.value = true;
                            messageController.clear();
                            await sendMessage;
                            isWaiting.value = false;
                          }
                        },
                        icon: !isWaiting.value
                            ? const Icon(Icons.send)
                            : const SizedBox(
                                width: 16,
                                height: 16,
                                child: CircularProgressIndicator(),
                              ),
                      ),
                    // é€ä¿¡ä¸­
                    if (isWaiting.value)
                      const IconButton(
                        onPressed: null,
                        icon: SizedBox(
                          width: 18,
                          height: 18,
                          child: CircularProgressIndicator(),
                        ),
                      ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```


#### å®ŒæˆğŸ¥³
æœ€çµ‚çš„ã«ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ChatGPTãŒç­”ãˆã¦ãã‚Œã¦ã„ã¾ã™ã€‚
ã¾ãŸã€ã‚‚ã†ä¸€åº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ãŸã¨ãã‚‚å‰å›ã®ä¼šè©±ã«åŸºã¥ã„ãŸè¿”ç­”ã«ãªã£ã¦ã„ã¾ã™ğŸ‘

![](/images/chatgpt_sample.png)


## ã¾ã¨ã‚
Flutterã‚¢ãƒ—ãƒªã«ChatGPTã‚’çµ„ã¿è¾¼ã‚“ã§ã¿ã¾ã—ãŸã€‚
ã‹ãªã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ã—ãŸãŒã€å·¥å¤«æ¬¡ç¬¬ã§å¤¢ãŒåºƒãŒã‚Šãã†ã§ã™ã­ã€‚
ä»Šå›ã¯dart_openaiã‚’ä½¿ã£ãŸä¾‹ã§ã™ãŒã€APIã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«é–¢ã™ã‚‹çŸ¥è­˜ãªã©ä»–ã®è¨€èªã§ã‚‚æ´»ã‹ã›ã‚‹ã®ã§ã€ã¾ãšã¯Flutterã§éŠã‚“ã§ã¿ã‚‹ã®ã‚‚è‰¯ã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å®Ÿè£…ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ˆã‹ã£ãŸã‚‰ç…®ã‚‹ãªã‚Šç„¼ããªã‚Šä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/K9i-0/flutter_chatgpt_sample
