---
title: "ã‚¿ã‚³ã§ã‚‚ã‚ã‹ã‚‹Dartãƒã‚¯ãƒ­ä½œæˆå…¥é–€"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['flutter', 'dart', 'macros']
publication_name: yumemi_inc
published: true
---
## ã¯ã˜ã‚ã«
:::message
Dart 3.4ç™ºè¡¨ç›´å¾Œã®è¨˜äº‹ãªã®ã§ã€æ•°ãƒ¶æœˆå¾Œã«ã¯å¤ã„æƒ…å ±ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
:::

Google I/O 2024ã§Flutterç™ºè¡¨ã®ç›®ç‰ã®ä¸€ã¤ã¨ã—ã¦ã€Dartã®ãƒã‚¯ãƒ­(macros)æ©Ÿèƒ½ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚
ã“ã‚Œã¾ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«é ¼ã£ã¦ã„ãŸJsonã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ»ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã€ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ä½œæˆãŒã‚ˆã‚ŠåŠ¹ç‡çš„ã«è¡Œãˆã‚‹ã¨ã„ã†ã“ã¨ã§æ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚ˆã‚Šè©³ã—ã„æƒ…å ±ã¯Dart 3.4ã®Mediumè¨˜äº‹ã‚’ã©ã†ã
https://medium.com/dartlang/dart-3-4-bd8d23b4462a


## ãƒã‚¯ãƒ­ã‚’è‡ªåˆ†ã§ã‚‚ä½œã£ã¦ã¿ãŸã„

ãƒã‚¯ãƒ­ã¯Dartã®devç‰ˆã€Flutterã®masterç‰ˆã§ã™ã§ã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
æµ·å¤–ã®ã¤ã‚ˆã¤ã‚ˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒã„ãã¤ã‹ãƒã‚¯ãƒ­ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

Dartå…¬å¼ã®JsonCodableãƒã‚¯ãƒ­
https://pub.dev/packages/json

Remiã•ã‚“ã®ãƒã‚¯ãƒ­ç‰ˆFreezed
https://pub.dev/packages/freezed/versions/3.0.0-0.0.dev

Felangelã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ãƒã‚¯ãƒ­
https://pub.dev/packages/data_class_macro

ã“ã‚Œã‚‰ãƒã‚¯ãƒ­ã‚’è©¦ã™åˆ†ã«ã¯ã„ã„ã®ã§ã™ãŒã€å€‹äººçš„ã«ã¯ã‚‚ã£ã¨ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ãŒã¿ãŸã„ãªãƒ¼ã¨æ€ã„ã¾ã—ãŸã€‚(ä½œã£ã¦ã‚‹äººãŸã¡ãŒã™ã”ã™ãã¦å®Ÿè£…ãŒé«˜åº¦ğŸ¥¹)

## ç°¡å˜ãªãƒã‚¯ãƒ­ã‚’ä½œã£ã¦ã¿ãŸ

ãã†ã„ã†è¨³ã§éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªHello World!ã¨ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹ã ã‘ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”Ÿã‚„ã™ãƒã‚¯ãƒ­ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/K9i-0/k9i_macro_sample

```dart
@Hello()
class Sample {}
```

ã¨ã™ã‚‹ã¨ã“ã†ã„ã†ã‚³ãƒ¼ãƒ‰ãŒä½œã‚‰ã‚Œã¦

```dart
augment class Sample {
  void hello() => print("Hello, World!");
}
```

mainãƒ¡ã‚½ãƒƒãƒ‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
```dart:main.dart
@Hello()
class Sample {}

void main() {
  final sample = Sample();
  sample.hello();
}
```

å®Ÿè¡Œæ™‚ã¯ã“ã®ã‚ˆã†ã«ã™ã‚Œã°ã€Hello World!ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
```zsh
$ dart --enable-experiment=macros run main.dart 
$ Hello, World!
```

## ä½œã‚Šæ–¹

ãã‚Œã§ã¯ã“ã®ãƒã‚¯ãƒ­ã®ä½œã‚Šæ–¹ã§ã™ã€‚

### devç‰ˆã®Dartã‚’å…¥ã‚Œã‚‹
è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã¯ãƒã‚¯ãƒ­ã‚’ä½¿ã†ã®ã«devç‰ˆã®DartãŒå¿…è¦ã§ã™ã€‚

ä»Šå›ã¯åŒåƒšã®[ãŠã‹ã‚„ã¾ã‚“ã•ã‚“](https://zenn.dev/blendthink)ãŒé–‹ç™ºã—ã¦ã„ã‚‹DVMï¼ˆDart Version Managementï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚

https://pub.dev/packages/dvmx

brewã‹pubã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
(pubã®å ´åˆdvmã˜ã‚ƒãªãã¦dvmxãªã®ã«æ³¨æ„)

```zsh:brewã®å ´åˆ
brew install blendfactory/tap/dvm
```
```zsh:pubã®å ´åˆ
dart pub global activate dvmx
```
:::message
dvm 0.0.7ã§pubã®å ´åˆinstallã§å¤±æ•—ã™ã‚‹ç¾è±¡ãŒèµ·ããŸã®ã§ç¾çŠ¶brewãŒãŠã™ã™ã‚ã§ã™ã€‚
:::

devç‰ˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```zsh
dvm install 3.5.0-164.0.dev
```

ä¸Šã¯åŸ·ç­†æ™‚ã®æœ€æ–°ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

```zsh
dvm list --remote -c dev
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

é©å½“ã«Dartãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚
åƒ•ã¯VSCodeã®ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã§Dart: New Project > Dart packageã§ä½œã‚Šã¾ã—ãŸã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§DVMã®æœ‰åŠ¹åŒ–ã‚’ã—ã¾ã™ã€‚
```zsh
dvm use 3.5.0-164.0.dev
```

ãƒ‘ã‚¹ã®è¨­å®š
```json:.vscode/settings.json
{
    "dart.sdkPath": ".dvm/dart_sdk",
}
```

#### ãƒã‚¯ãƒ­ã®ä¾å­˜è¿½åŠ 

è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã®æœ€æ–°ã®macrosã‚’ä¾å­˜ã«è¿½åŠ ã—ã¾ã™ã€‚

```yaml:pubspec.yaml
dependencies:
  macros: ^0.1.0-main.5
```

å®Ÿæ…‹ã¯ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/dart-lang/sdk/tree/main/pkg/macros

ã“ã‚ŒãŒdart sdkã«å…¥ã£ã¦ã„ã‚‹_macros 0.1.5ã«ä¾å­˜ã—ã¦ãŠã‚Šã€0.1.5ã¯devç‰ˆç§»è¡Œã«ã—ã‹ã¾ã ãªã„ã®ã§ã€devç‰ˆã®DartãŒå¿…è¦ã§ã™ã€‚
```yaml:macrosã®pubspec.yaml
name: macros
version: 0.1.0-main.5
description: >-
  This package is for macro authors, and exposes the APIs necessary to write
  a macro. It exports the APIs from the private `_macros` SDK vendored package.
repository: https://github.com/dart-lang/sdk/tree/main/pkg/macros

environment:
  sdk: ^3.4.0-256.0.dev

dependencies:
  _macros:
    sdk: dart
    version: 0.1.5
```

#### ãƒã‚¯ãƒ­ã®æœ‰åŠ¹åŒ–
analysis_optionsã‚’æ›¸ãæ›ãˆã¾ã™ã€‚
```yaml:analysis_options.yaml
analyzer:
  # macroæœ‰åŠ¹åŒ–
  enable-experiment:
    - macros
```

### ãƒã‚¯ãƒ­ã‚’æ›¸ã
ä½œæˆã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®libç›´ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å.dartã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã¯ãšã§ã™ã€‚

:::message
é€šå¸¸ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹ã¨lib/srcã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å_base.dartã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œãã‚ŒãŒexportã•ã‚Œã‚‹ã®ã§ã™ãŒã€ãƒã‚¯ãƒ­ãŒã¾ã ä¸å®‰å®šã ã‹ã‚‰ã‹libç›´ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æ¥ãƒã‚¯ãƒ­ã‚’å®šç¾©ã—ãªã„ã¨VSCodeãŒå¾Œè¿°ã™ã‚‹Go to Augmentationã‚’è¡¨ç¤ºã—ã¾ã›ã‚“ã§ã—ãŸã€‚

ã€è¿½è¨˜ã€‘
ã“ã¡ã‚‰ã®ãƒã‚°ã¯ä»¥ä¸‹ã®commitã§ä¿®æ­£ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚
https://github.com/dart-lang/sdk/commit/73bdc86dd50e11cedb3bf976c597a02ad209bdb4

3.5.0-163.0.devä»¥ä¸Šã‚’ä½¿ãˆã°å•é¡Œã¯ç™ºç”Ÿã—ãªãã†ã§ã™ã€‚
[æ‘æ¾ã•ã‚“èª¿æŸ»å”åŠ›](https://x.com/riscait/status/1793837301652771172)ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ™
:::

Hello Worldã‚’è¡¨ç¤ºã—ãŸã„ã ã‘ãªã‚‰ã“ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```dart:lib/ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å.dart
library;

// exportã™ã‚‹ã¨VS Codeã«Go to AugmentationãŒè¡¨ç¤ºã•ã‚Œãªã„ï¼Ÿ
// export 'src/k9i_macro_sample_base.dart';
import 'dart:async';

import 'package:macros/macros.dart';

macro class Hello implements ClassDeclarationsMacro {
  const Hello();

  @override
  FutureOr<void> buildDeclarationsForClass(ClassDeclaration clazz, MemberDeclarationBuilder builder) async {
    final methods = await builder.methodsOf(clazz);
    final hello =
        methods.where((e) => e.identifier.name == 'hello').firstOrNull;

    if (hello != null) return;

    builder.declareInType(
      DeclarationCode.fromParts(
        [
          '  void hello() => print("Hello, World!");',
        ]
      ),
    );
  }
}
```

ClassDeclarationsMacroã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã™ã‚‹buildDeclarationsForClassã«ç”Ÿæˆå‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚
builderã®declareInTypeã«ç”Ÿæˆã—ãŸã„helloãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’æ¸¡ã—ã¾ã™ã€‚

### ä½¿ã£ã¦ã¿ã‚‹

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆæ™‚ã«ä½œã‚‰ã‚ŒãŸexample/ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å_example.dartã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã¯k9i_macro_sampleã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã ã£ãŸå ´åˆã®ä¾‹ã§ã™ã€‚

```dart:example/ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å_example.dart
import 'package:k9i_macro_sample/k9i_macro_sample.dart';

@Hello()
class Sample {}

void main() {
  final sample = Sample();
  sample.hello();
}
```

å®Ÿè¡Œæ™‚ã¯ã€Œç°¡å˜ãªãƒã‚¯ãƒ­ã‚’ä½œã£ã¦ã¿ãŸã€ã§èª¬æ˜ã—ãŸã‚ˆã†ã«--enable-experiment=macrosãŒå¿…è¦ã§ã™ã€‚

dvmã‚’ä½¿ã£ãŸã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®å®Ÿè¡Œãªã‚‰
```zsh
dvm dart --enable-experiment=macros run example/k9i_macro_sample_example.dart
```
ã¨ã„ã£ãŸæ„Ÿã˜

### ã‚ªãƒ¼ã‚°ãƒ¡ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’è¦‹ã¦ã¿ã‚‹

ãƒã‚¯ãƒ­ã§ä½œã‚‰ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯VS Codeã®ã€ŒGo to Augmentationã€ã¨ã„ã†CodeLensã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

![](/images/macros_go_to_augmentation.png =500x)

ã“ã‚“ãªæ„Ÿã˜ã®ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒè¦‹ãˆã‚‹ã¨æ€ã„ã¾ã™ã€‚

```dart
augment library 'file:///ç•¥/k9i_macro_sample/example/k9i_macro_sample_example.dart';

augment class Sample {
  void hello() => print("Hello, World!");
}
```


ã“ã®ã‚ªãƒ¼ã‚°ãƒ¡ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ï¼ˆaugment classï¼‰ãŒãƒã‚¯ãƒ­ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ã‚ªãƒ¼ã‚°ãƒ¡ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã¯ãƒã‚¯ãƒ­æœ¬ä½“ã‚’æ›¸ãæ›ãˆãŸæ™‚ã‚‚ãƒã‚¯ãƒ­åˆ©ç”¨ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆãŸã¨ãã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤‰æ›´ã•ã‚Œã‚‹ã®ãŒéå¸¸ã«å¿«é©ã«æ€ãˆã¾ã—ãŸã€‚

## ã¾ã¨ã‚
éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªãƒã‚¯ãƒ­ã®ä½œã‚Šæ–¹ç´¹ä»‹ã§ã—ãŸã€‚
ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã‚¹ã‚¿ãƒ¼ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ¥³

https://github.com/K9i-0/k9i_macro_sample