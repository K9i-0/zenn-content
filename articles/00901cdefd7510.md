---
title: "go_router_builder 3.0.0の破壊的変更について"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Flutter", "Dart", "go_router", "go_router_builder"]
published: false
---

# go_router_builder 3.0.0の破壊的変更について

## はじめに

2025年6月にリリースされた`go_router_builder 3.0.0`には、**破壊的変更**が含まれています。既存のプロジェクトで`go_router_builder`を使用している場合、アップデート時に対応が必要になります。

この記事では、具体的な変更内容とマイグレーション方法について詳しく解説します。

## 破壊的変更の内容

### Route classes now required to use a mixin `with _$RouteName`

go_router_builder 3.0.0の最も重要な変更は、**ルートクラスでmixinの使用が必須**になったことです。

#### 変更前（2.x.x）

```dart:routes.dart
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData {
  const HomeRoute();

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const HomeScreen();
  }
}
```

#### 変更後（3.0.0）

```dart:routes.dart
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData with _$HomeRoute {
  const HomeRoute();

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const HomeScreen();
  }
}
```

## マイグレーション手順

### 1. pubspec.yamlの更新

まず、`go_router_builder`のバージョンを3.0.0に更新します：

```yaml:pubspec.yaml
dev_dependencies:
  go_router_builder: ^3.0.0
  build_runner: ^2.0.0
```

### 2. ルートクラスの修正

既存の全てのルートクラスに適切なmixinを追加します：

```dart:routes.dart
// HomeRoute
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData with _$HomeRoute {
  // ... 既存のコード
}

// 子ルートの例
@TypedGoRoute<ProductDetailRoute>(path: '/product/:id')
class ProductDetailRoute extends GoRouteData with _$ProductDetailRoute {
  final String id;
  
  const ProductDetailRoute({required this.id});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return ProductDetailScreen(productId: id);
  }
}

// ShellRouteの例
class MainShellRoute extends ShellRouteData with _$MainShellRoute {
  const MainShellRoute();

  @override
  Widget builder(BuildContext context, GoRouterState state, Widget navigator) {
    return MainShell(child: navigator);
  }
}
```

### 3. コード生成の実行

修正後、コード生成を実行します：

```bash:ターミナル
dart run build_runner build --delete-conflicting-outputs
```

## 実際のマイグレーション例

### シンプルなルート

```dart:routes.dart
// 変更前
@TypedGoRoute<LoginRoute>(path: '/login')
class LoginRoute extends GoRouteData {
  final String? redirectPath;
  
  const LoginRoute({this.redirectPath});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return LoginScreen(redirectPath: redirectPath);
  }
}

// 変更後
@TypedGoRoute<LoginRoute>(path: '/login')
class LoginRoute extends GoRouteData with _$LoginRoute {
  final String? redirectPath;
  
  const LoginRoute({this.redirectPath});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return LoginScreen(redirectPath: redirectPath);
  }
}
```

### 複雑なルート（リダイレクト付き）

```dart:routes.dart
// 変更前
@TypedGoRoute<ProfileRoute>(path: '/profile')
class ProfileRoute extends GoRouteData {
  const ProfileRoute();

  @override
  String? redirect(BuildContext context, GoRouterState state) {
    final authState = AuthProvider.of(context);
    if (!authState.isLoggedIn) {
      return const LoginRoute().location;
    }
    return null;
  }

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const ProfileScreen();
  }
}

// 変更後
@TypedGoRoute<ProfileRoute>(path: '/profile')
class ProfileRoute extends GoRouteData with _$ProfileRoute {
  const ProfileRoute();

  @override
  String? redirect(BuildContext context, GoRouterState state) {
    final authState = AuthProvider.of(context);
    if (!authState.isLoggedIn) {
      return const LoginRoute().location;
    }
    return null;
  }

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const ProfileScreen();
  }
}
```

## 自動化ツールでの対応

### 一括置換の活用

大規模なプロジェクトでは、エディタの一括置換機能を活用できます：

**検索パターン：**
```
class (\w+Route) extends GoRouteData \{
```

**置換パターン：**
```
class $1 extends GoRouteData with _$$1 {
```

### VSCodeの場合

1. `Cmd/Ctrl + Shift + H`で置換ダイアログを開く
2. 正規表現モードを有効にする（`.*`アイコン）
3. 上記のパターンで一括置換

## トラブルシューティング

### よくある問題

#### 1. コード生成エラー

```bash:ターミナル
[SEVERE] go_router_builder on lib/routes.dart:
Missing mixin _$HomeRoute on HomeRoute
```

**解決方法：**
該当のルートクラスに`with _$RouteName`を追加してください。

#### 2. 既存の生成ファイルとの競合

```bash:ターミナル
[WARNING] Conflicting outputs were detected
```

**解決方法：**
```bash:ターミナル
dart run build_runner clean
dart run build_runner build
```

#### 3. 型エラー

```bash:ターミナル
The mixin '_$HomeRoute' can't be mixed in because it's missing...
```

**解決方法：**
1. `part`ディレクティブが正しく記述されているか確認
2. コード生成が正常に完了しているか確認

## 移行チェックリスト

- [ ] `pubspec.yaml`で`go_router_builder`を3.0.0に更新
- [ ] 全ての`GoRouteData`継承クラスに適切なmixinを追加
- [ ] 全ての`ShellRouteData`継承クラスに適切なmixinを追加
- [ ] コード生成を実行（`dart run build_runner build`）
- [ ] ビルドエラーがないことを確認
- [ ] テストが正常に通ることを確認

## まとめ

go_router_builder 3.0.0では、ルートクラスでのmixin使用が必須になりました。変更自体は単純ですが、既存のプロジェクトでは全てのルートクラスの修正が必要です。

**ポイント：**
- 全ての`GoRouteData`クラスに`with _$ClassName`を追加
- コード生成の再実行が必須
- 一括置換で効率的にマイグレーション可能

この変更により、型安全性が向上し、より確実なコード生成が可能になります。早めのマイグレーションをおすすめします。

### 参考リンク

- [go_router_builder 3.0.0 Changelog](https://pub.dev/packages/go_router_builder/changelog)
- [go_router公式ドキュメント](https://pub.dev/packages/go_router)
- [Flutter公式: Type-safe routing](https://docs.flutter.dev/ui/navigation/go-router)
