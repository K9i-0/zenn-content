---
title: "go_router_builder 3.0.0の破壊的変更について"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Flutter", "Dart", "go_router", "go_router_builder"]
published: false
---

# go_router_builder 3.0.0の破壊的変更について

go_router_builderが3.0.0にアップデートされて、破壊的変更が入りました。
既存プロジェクトでgo_router_builderを使ってる人は対応が必要です。

今回の記事では、変更内容とマイグレーション方法だけでなく、**なぜこの変更が必要だったのか**と**何ができるようになったのか**を詳しく説明します。

## 今回の変更の背景

### 根本的な問題

go_router_builder 2.x.xでは、ルートクラスに対してextensionで`go(context)`や`push(context)`、`location`などのメソッドを生成していました。

しかし、この方法には重要な制限がありました：

```dart
// 2.x.xの場合
GoRouteData route; // 抽象的な型

route.go(context); // ❌ Error: 'go'は定義されていない
route.location;    // ❌ Error: 'location'は定義されていない
```

なぜなら、extensionのメソッドは具体的なクラス（`HomeRoute`、`LoginRoute`など）でしか利用できず、基底クラス（`GoRouteData`）では使えないからです。

これが[Issue #106790](https://github.com/flutter/flutter/issues/106790)で報告された問題でした。

### 実際の問題例

```dart
// 2.x.xでは以下のようなコードが書けませんでした
extension on GoRouteData {
  void customGo(BuildContext context) {
    go(context); // ❌ extensionのメソッドは見えない
  }
}

// 動的なルーティングも困難
void navigateToRoute(GoRouteData route, BuildContext context) {
  route.go(context); // ❌ extensionのメソッドは見えない
}
```

## 何が変わったか

### Route classes now required to use a mixin `with _$RouteName`

一番大きな変更は、**ルートクラスでmixinの使用が必須**になったことです。

#### 変更前（2.x.x）

```dart:routes.dart
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData {
  const HomeRoute();

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const HomeScreen();
  }
}
```

生成されるコード：
```dart:routes.g.dart
extension $HomeRouteExtension on HomeRoute {
  String get location => '/';
  void go(BuildContext context) => context.go(location);
  void push(BuildContext context) => context.push(location);
}
```

#### 変更後（3.0.0）

```dart:routes.dart
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData with _$HomeRoute {
  const HomeRoute();

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const HomeScreen();
  }
}
```

生成されるコード：
```dart:routes.g.dart
mixin _$HomeRoute on GoRouteData {
  String get location => '/';
  void go(BuildContext context) => context.go(location);
  void push(BuildContext context) => context.push(location);
}
```

## この変更で何ができるようになったか

### 1. 抽象的な型での操作が可能

```dart
// 3.0.0では可能！
GoRouteData route = const HomeRoute();

route.go(context);    // ✅ OK
route.location;       // ✅ OK
route.push(context);  // ✅ OK
```

### 2. 共通のextensionを作成可能

```dart
extension GoRouteDataExtension on GoRouteData {
  void safeGo(BuildContext context) {
    // 何らかの前処理
    if (mounted) {
      go(context); // ✅ mixinのメソッドが使える
    }
  }
  
  void goWithAnalytics(BuildContext context, {Map<String, dynamic>? parameters}) {
    // アナリティクスログ
    Analytics.track('route_navigation', {
      'route': location,
      ...?parameters,
    });
    go(context);
  }
}
```

### 3. 動的なルーティングロジック

```dart
class RoutingService {
  static void navigateTo(GoRouteData route, BuildContext context) {
    // ✅ 任意のルートを受け取って遷移可能
    route.go(context);
  }
  
  static void conditionalNavigation(BuildContext context) {
    final route = userIsLoggedIn ? const HomeRoute() : const LoginRoute();
    route.go(context); // ✅ 動的にルートを決めて遷移
  }
}
```

### 4. より良いアーキテクチャパターン

```dart
abstract class BaseRoute extends GoRouteData {
  // 共通の振る舞いを定義
  void navigateWithPermissionCheck(BuildContext context) {
    if (hasPermission()) {
      go(context); // ✅ mixinのメソッドが使える
    } else {
      const PermissionDeniedRoute().go(context);
    }
  }
}

class HomeRoute extends BaseRoute with _$HomeRoute {
  // 具体的な実装
}
```

## マイグレーション手順

### 1. pubspec.yamlの更新

まず、go_router_builderのバージョンを3.0.0に更新します。

```yaml:pubspec.yaml
dev_dependencies:
  go_router_builder: ^3.0.0
  build_runner: ^2.0.0
```

### 2. ルートクラスの修正

全てのルートクラスに適切なmixinを追加していきます。

```dart:routes.dart
// HomeRoute
@TypedGoRoute<HomeRoute>(path: '/')
class HomeRoute extends GoRouteData with _$HomeRoute {
  // ... 既存のコード
}

// 子ルートの例
@TypedGoRoute<ProductDetailRoute>(path: '/product/:id')
class ProductDetailRoute extends GoRouteData with _$ProductDetailRoute {
  final String id;
  
  const ProductDetailRoute({required this.id});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return ProductDetailScreen(productId: id);
  }
}

// ShellRouteの例
class MainShellRoute extends ShellRouteData with _$MainShellRoute {
  const MainShellRoute();

  @override
  Widget builder(BuildContext context, GoRouterState state, Widget navigator) {
    return MainShell(child: navigator);
  }
}
```

### 3. コード生成の実行

修正後、コード生成を実行します。

```bash:ターミナル
dart run build_runner build --delete-conflicting-outputs
```

## 実際のマイグレーション例

### シンプルなルート

```dart:routes.dart
// 変更前
@TypedGoRoute<LoginRoute>(path: '/login')
class LoginRoute extends GoRouteData {
  final String? redirectPath;
  
  const LoginRoute({this.redirectPath});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return LoginScreen(redirectPath: redirectPath);
  }
}

// 変更後
@TypedGoRoute<LoginRoute>(path: '/login')
class LoginRoute extends GoRouteData with _$LoginRoute {
  final String? redirectPath;
  
  const LoginRoute({this.redirectPath});

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return LoginScreen(redirectPath: redirectPath);
  }
}
```

### 複雑なルート（リダイレクト付き）

```dart:routes.dart
// 変更前
@TypedGoRoute<ProfileRoute>(path: '/profile')
class ProfileRoute extends GoRouteData {
  const ProfileRoute();

  @override
  String? redirect(BuildContext context, GoRouterState state) {
    final authState = AuthProvider.of(context);
    if (!authState.isLoggedIn) {
      return const LoginRoute().location;
    }
    return null;
  }

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const ProfileScreen();
  }
}

// 変更後
@TypedGoRoute<ProfileRoute>(path: '/profile')
class ProfileRoute extends GoRouteData with _$ProfileRoute {
  const ProfileRoute();

  @override
  String? redirect(BuildContext context, GoRouterState state) {
    final authState = AuthProvider.of(context);
    if (!authState.isLoggedIn) {
      return const LoginRoute().location;
    }
    return null;
  }

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const ProfileScreen();
  }
}
```

## 効率的にやる方法

### 一括置換を使う

大規模なプロジェクトなら、エディタの一括置換が便利です。

**検索パターン：**
```
class (\w+Route) extends GoRouteData \{
```

**置換パターン：**
```
class $1 extends GoRouteData with _$$1 {
```

### VSCodeの場合

1. `Cmd/Ctrl + Shift + H`で置換ダイアログを開く
2. 正規表現モードを有効にする（`.*`アイコン）
3. 上記のパターンで一括置換

## よくあるトラブル

### コード生成エラー

```bash:ターミナル
[SEVERE] go_router_builder on lib/routes.dart:
Missing mixin _$HomeRoute on HomeRoute
```

該当のルートクラスに`with _$RouteName`を追加し忘れてます。

### 既存の生成ファイルとの競合

```bash:ターミナル
[WARNING] Conflicting outputs were detected
```

以下のコマンドで一度クリーンしてから再生成しましょう。
```bash:ターミナル
dart run build_runner clean
dart run build_runner build
```

### 型エラー

```bash:ターミナル
The mixin '_$HomeRoute' can't be mixed in because it's missing...
```

- `part`ディレクティブが正しく記述されているか確認
- コード生成が正常に完了しているか確認

## 今後の展望

今回のmixin化により、将来的には以下のような機能が追加される可能性があります：

- `GoRouteData`の基底クラスに直接ルーティングメソッドを追加
- より高度な型安全なルーティングAPI
- カスタムナビゲーション動作の統一的な実装

詳細は[PR #9275](https://github.com/flutter/packages/pull/9275)と[関連するPR](https://github.com/flutter/packages/pull/9277)で確認できます。

## チェックリスト

- [ ] pubspec.yamlでgo_router_builderを3.0.0に更新
- [ ] 全てのGoRouteData継承クラスに適切なmixinを追加
- [ ] 全てのShellRouteData継承クラスに適切なmixinを追加
- [ ] コード生成を実行（`dart run build_runner build`）
- [ ] ビルドエラーがないことを確認
- [ ] テストが正常に通ることを確認

## まとめ

go_router_builder 3.0.0では、ルートクラスでのmixin使用が必須になりました。
これは単なる変更ではなく、**型安全なルーティングをより柔軟で強力**にするための重要なアップデートです。

変更自体は単純ですが、既存プロジェクトでは全てのルートクラスの修正が必要です。

ポイントは以下の通り：
- **背景**: extensionの制限により抽象的な型での操作ができなかった
- **変更**: extensionからmixinへの移行で柔軟性が向上
- **メリット**: 動的ルーティング、共通処理、より良いアーキテクチャが可能に
- **マイグレーション**: 全てのGoRouteDataクラスに`with _$ClassName`を追加

この変更で型安全性が向上し、より確実で保守しやすいコード生成ができるようになります。
早めにマイグレーションしておくのがおすすめです👍

### 参考リンク

- [Issue #106790 - 今回の変更の背景](https://github.com/flutter/flutter/issues/106790)
- [PR #9275 - mixin実装](https://github.com/flutter/packages/pull/9275)
- [go_router_builder 3.0.0 Changelog](https://pub.dev/packages/go_router_builder/changelog)
- [go_router公式ドキュメント](https://pub.dev/packages/go_router)
- [Flutter公式: Type-safe routing](https://docs.flutter.dev/ui/navigation/go-router)
