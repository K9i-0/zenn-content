---
title: "Grinderã‚’ä½¿ã£ã¦ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’Dartã§æ›¸ã"
emoji: "ğŸ‘¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Flutter", "Dart"]
published: true
---
Dartã§æ›¸ã„ãŸã‚¿ã‚¹ã‚¯ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚„CIã§å®Ÿè¡Œã§ãã‚‹Grinderãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç´¹ä»‹ã§ã™ã€‚
https://pub.dev/packages/grinder
Grinderã‚’å°å…¥ã™ã‚‹ã¨grind {ã‚¿ã‚¹ã‚¯å}ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰è‰²ã€…ãªã‚¿ã‚¹ã‚¯ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚è‡ªåˆ†ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ã‚’grinderã§å®Ÿè¡Œã—ã¦ã¾ã™ã€‚
- build_runnerã®å®Ÿè¡Œ(ã‚³ãƒãƒ³ãƒ‰æ¯å›å¿˜ã‚Œã‚‹ã‚„ã¤)
- ãƒªãƒªãƒ¼ã‚¹æ™‚ã®pubspec.yamlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
- ãƒªãƒªãƒ¼ã‚¹Pull Requestã®ä½œæˆ

# å°å…¥æ–¹æ³•
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
```
dart pub global activate grinder
```
ãƒ‘ã‚¹ãŒé€šã£ã¦ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰.zshrcã‚„.bashrcã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```text:.zshrc
export PATH="$PATH":"$HOME/.pub-cache/bin"
```

# ä½¿ã„æ–¹
1. pubspec.yamlã®dev_dependenciesã«grinderã‚’è¿½åŠ ã—ã¾ã™ã€‚
```yaml:pubspec.yaml
dev_dependencies:
  grinder: ^0.9.0
```
(ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯åŸ·ç­†æ™‚ã®æœ€æ–°ã§ã™)

2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«toolãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã€ãã“ã«grind.dartã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```dart:tool/grind.dart
import 'package:grinder/grinder.dart';

main(List<String> args) => grind(args);
```

3. Taskã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ã‚¿ã‚¹ã‚¯ã‚’ä½œã‚‹
 ```dart:tool/grind.dart
@Task('Generate docs.')
void doc() {
  log("Generating docs...");
}
```

4. å®Ÿè¡Œã™ã‚‹
grind -hã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯ãŒç¢ºèªã§ãã¾ã™
docãŒã‚¿ã‚¹ã‚¯åã§ã™
```text:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ grind -h
~~~
Available tasks:
  doc          Generate docs.
```
grind docã®ã‚ˆã†ã«grindã®å¾Œã«ã‚¿ã‚¹ã‚¯åã‚’æŒ‡å®šã™ã‚‹ã¨ã€Dartã§æ›¸ã„ãŸã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
```text:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ grind doc
```

# å…·ä½“ä¾‹
æœ€è¿‘æ›¸ã„ãŸã‚¿ã‚¹ã‚¯ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚æ°—ã«å…¥ã£ãŸã‚‰ã‚³ãƒ”ãƒšã—ã¦ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
## ã‚ˆãä½¿ã†zshã®ã‚³ãƒãƒ³ãƒ‰ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
ã‚ˆãä½¿ã†ã‘ã©è¦šãˆã‚‰ã‚Œãªã„ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ã‚¹ã‚¯åŒ–ã—ã¦ã¾ã™ã€‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§ã‚‚ã„ã„ã§ã™ãŒã€grinderã®ã‚¿ã‚¹ã‚¯ã«ã™ã‚‹ã¨Flutterãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚»ãƒƒãƒˆã§æ‰±ãˆã‚‹ã®ã§ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨æ°—è»½ã«å…±æœ‰ã§ãã‚‹ã®ãŒè‰¯ã„ã§ã™ã€‚

runã¯grinderãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ioãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®Process.runãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚‚ã®ã§ã™ã€‚
```dart:tool/grind.dart
@Task('build_runnerã§ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ')
Future<void> generate() async {
  run(
    'flutter',
    arguments: ['pub', 'run', 'build_runner', 'build', '--delete-conflicting-outputs'],
  );
}

@Task('CocoaPodsã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒ—ãƒ‡æ™‚ã«ä½¿ã†)')
void updatePods() {
  run(
    'rm',
    arguments: ['-rf', 'Pods/'],
    workingDirectory: 'ios',
  );
  run(
    'rm',
    arguments: ['-rf', 'Podfile.lock'],
    workingDirectory: 'ios',
  );
  run(
    'flutter',
    arguments: ['clean'],
  );
  run(
    'flutter',
    arguments: ['pub', 'get'],
  );
  run(
    'pod',
    arguments: ['install', '--repo-update'],
    workingDirectory: 'ios',
  );
}
```
## pubspec.yamlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ç‰¹å®šã®æ–‡å­—åˆ—ã®ç½®æ›ã¿ãŸã„ãªæ“ä½œã‚‚Dartãªã®ã§æ°—è»½ã«ã§ãã¾ã™ã€‚
- context.invocation.argumentsã§å¼•æ•°ã‚’å—ã‘å–ã£ã¦ã¾ã™
- failãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦å¼•æ•°ãŒãªã„ã¨ãå‡¦ç†ã‚’æ­¢ã‚ã¦ã¾ã™
```dart:tool/grind.dart
@Task('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°')
String incrementVersion() {
  final args = context.invocation.arguments;
  final newVersionName = args.getOption('version-name');
  if (newVersionName == null) {
    fail('--version-name=X.X.Xã§æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
  }

  final pubspecFile = File('./pubspec.yaml');
  final pubspecString = pubspecFile.readAsStringSync();

  final pubspec = loadYaml(pubspecString);
  final version = pubspec['version'] as String;
  final splits = version.split('+');
  final versionCode = int.parse(splits[1]);
  final newVersionCode = versionCode + 1;

  final updatedPubspecString = pubspecString.replaceFirst(
    'version: $version',
    'version: $newVersionName+$newVersionCode',
  );
  pubspecFile.writeAsStringSync(updatedPubspecString);

  return '$newVersionName+$newVersionCode';
}
```
ä¸Šè¨˜ã®ã‚¿ã‚¹ã‚¯ã«ã¯yamlãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚
https://pub.dev/packages/yaml

å®Ÿè¡Œæ™‚ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```text:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
grind increment-version --version-name=1.0.1
```

# è£œè¶³
## ãŠã™ã™ã‚ã®ä½¿ã„æ–¹
Grinderã®ã‚¿ã‚¹ã‚¯ãŒå¢—ãˆã¦ã‚‹ã¨grind.dartãŒèª­ã¿ã¥ã‚‰ããªã‚‹ã®ã§ã€è‡ªåˆ†ã¯partã§ã‚¿ã‚¹ã‚¯ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã¾ã—ãŸã€‚
```text:ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
tool
â”œâ”€â”€ grind.dart
â””â”€â”€ grinder_task
    â”œâ”€â”€ generate.dart
    â”œâ”€â”€ increment_version.dart
    â””â”€â”€ update_pods.dart
```
```dart:tool/grind.dart
import 'package:grinder/grinder.dart';

part 'grinder_task/generate.dart';
part 'grinder_task/increment_version.dart';
part 'grinder_task/update_pods.dart';

main(List<String> args) => grind(args);
```
```dart:tool/grinder_task/generate.dart
part of '../grind.dart';

@Task('build_runnerã§ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ')
Future<void> generate() async {
  run(
    'flutter',
    arguments: ['pub', 'run', 'build_runner', 'build', '--delete-conflicting-outputs'],
  );
}
```
## ãƒ—ãƒ­ã‚»ã‚¹ã®çµŒéã‚’è¡¨ç¤ºã™ã‚‹
grinderãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®runã‚’ä½¿ã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨å®Œäº†ã¾ã§ãƒ­ã‚°ãŒå‡ºã¾ã›ã‚“ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã°çµŒéãŒè¡¨ç¤ºã§ãã¾ã™ã€‚
```dart:tool/grind.dart
Future<void> runCommand({
  required String command,
}) async {
  final splittedCommand = command.split(' ');
  log(command);
  final process = await Process.start(
    splittedCommand.first,
    splittedCommand.sublist(1),
  );
  stdout.addStream(process.stdout);
  stderr.addStream(process.stderr);
}
```
åˆ©ç”¨å´
```dart:tool/grinder_task/generate.dart
part of '../grind.dart';

@Task('build_runnerã§ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ')
Future<void> generate() async {
  runCommand(
    command: 'flutter pub run build_runner build --delete-conflicting-outputs',
  );
}
```

## ãã®ä»–ã®Grinderã‚¿ã‚¹ã‚¯ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
å…·ä½“ä¾‹ã§ä½¿ã„ã¾ã›ã‚“ã§ã—ãŸãŒã€@DefaultTaskã¨@Dependsã¨ã„ã†ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯å…¬å¼ã®Readmeã‚’è¦‹ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ãã‚Œãã‚Œ
- @DefaultTask: grindã¨ã ã‘æ‰“ã£ãŸã¨ãå®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã«ã¤ã‘ã‚‹
- @Depends: ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå‰ã«ä»–ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹
  
ã‚‚ã®ã§ã™ã€‚

## Github Actionsã§åˆ©ç”¨ã™ã‚‹
Grinderã®ã‚¿ã‚¹ã‚¯ã‚’Github Actionsã®workflowã«çµ„ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
flutter pub getã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€åˆ©ç”¨ã¯Flutteré–¢é€£ã®å‡¦ç†ã«ã¨ã©ã‚ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã§ã™ã€‚
ã“ã‚“ãªæ„Ÿã˜ã§ã™
```yaml:.github/workflows/flutter_analyze.yml
name: on release pr merged
on:
    pull_request:
        branches:
            - master
        types: [closed]

jobs:
  on-release-pr-merged:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v2.3.4
      - name: "Install Flutter"
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - run: flutter pub get
      - name: grinder task
        run: dart tool/grind.dart hoge
```

# Derryãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã®æ¯”è¼ƒ
Flutterãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã¨ã—ã¦Derryãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚
https://zenn.dev/k9i/articles/c54446a72f1f46
æ‰‹è»½ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å…±æœ‰ã™ã‚‹ã ã‘ãªã‚‰Derryã€ã‚ˆã‚Šè¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã‚’å…±æœ‰ã—ãŸã„ãªã‚‰GrinderãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚å€‹äººçš„ã«ã¯ä¸¡æ–¹ä½¿ã„åˆ†ã‘ã‚‹ã®ã¯ã‚„ã‚„ã“ã—ã„ã®ã§Grinderã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ã¾ã¨ã‚
Flutterã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã¨ã£ã¦ä½¿ã„æ…£ã‚ŒãŸDartã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ›¸ã‘ã‚‹ã®ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã­ã€‚

## è¿½è¨˜
æœ€è¿‘ã¯ã“ã‚“ãªæ„Ÿã˜ã®è¨­å®šã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ã‚ˆã‹ã£ãŸã‚‰å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
æ°—ã«å…¥ã£ãŸã‚‰ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¹ã‚¿ãƒ¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨ãƒ¢ãƒãƒ™ãŒä¸ŠãŒã‚Šã¾ã™w
https://github.com/K9i-0/flutter_k9i_portfolio/blob/main/tool/grind.dart