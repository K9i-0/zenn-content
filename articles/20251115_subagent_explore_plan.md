---
title: "Claude Code のビルトインサブエージェント - ExploreとPlanの実態"
emoji: "🤖"
type: "idea"
topics: ["Claude", "Claude Code", "AIエージェント", "Anthropic", "MCP"]
published: false
---

前回の記事では、MCPの欠点とその対策について述べました。その中で、**サブエージェントを活用することでコンテキストを分離し、トークン消費を削減できる**と紹介しました。

しかし実は、Claude Code には開発者が気づかないうちに自動的に起動する**ビルトインサブエージェント**が搭載されています。それが **Explore** と **Plan** です。

この記事では、これら2つのビルトインサブエージェントの正体、仕組み、そして活用法について詳しく解説します。

## サブエージェントとは（簡潔におさらい）

サブエージェントは、**独立したコンテキストウィンドウで動作する専門的なAIエージェント**です。メインエージェントとは別のコンテキストで実行されるため、以下のメリットがあります：

- **コンテキスト分離**: メインエージェントとのコンテキスト圧迫を回避
- **特化した能力**: 特定の役割に最適化されたシステムプロンプト
- **ツールアクセス制御**: 必要なツールのみを選択的に割り当て

ユーザーがカスタムサブエージェントを手動で作成することもできます。しかし、Claude Code は既に 2 つの強力なビルトインサブエージェントを用意しており、多くのユーザーは**その存在や動作すら意識していません**。

## Explore サブエージェント

### 導入背景と目的

Explore サブエージェントは v2.0.17（2025年10月）で導入されました[^1]。その目的は、**コードベース探索を高速かつ低コストで実現すること**です。

前回の記事で「MCPツール定義によるコンテキスト圧迫」について触れましたが、同じ課題がコードベース探索にもあります。ユーザーが「このファイルを見てほしい」と頼む際、クライアントがファイル全体をコンテキストに読み込むと、トークン消費が増加してしまいます。

Explore サブエージェントは、この課題を解決するために設計されました。

### Haiku 4.5 による効率化

Explore サブエージェントの最大の特徴は、**Haiku 4.5 で駆動されている**ことです[^1]。

Haiku は、Claude のモデルの中で最も軽量で高速です。同時に、**コード理解と質問応答の精度は十分**です。Anthropic は意図的に、高速性とコスト効率を優先し、このモデルを選択しました。

結果として：
- **処理速度**: Sonnet や Opus と比較して著しく高速
- **トークン消費**: 同じタスクで大幅に削減
- **コスト**: 他のモデルの数分の一

「コードベース探索」というタスクに限定すれば、Haiku の性能は十分であり、より高度なモデルを使う必要はない、という設計判断です。これは、MCPの「オンデマンドツール読み込み」と同じ思想——**必要な能力だけを選択的に用いる**——に通じています。

### いつ自動的に使われるか

Explore サブエージェントは、以下のような場面で**自動的に起動**されます：

1. **Planモード中の調査フェーズ**
   - Plan モード（Shift+Tab×2で有効化）では、実行を避けながらコードベースの理解が必要になります
   - この時、Explore サブエージェントが自動的に呼び出され、効率的なファイル検索・コード構造分析を行います

2. **広範囲なコードベース検索が必要な場合**
   - メインエージェントが膨大なコードを読む必要があると判断したとき
   - 複数のファイルを比較・分析する必要があるとき

ユーザーは明示的な指示を出す必要はありません。Claude Code が判断して自動的に Explore サブエージェントに任務を委譲します。

### コンテキスト効率化の仕組み

Explore サブエージェントが効率的な理由は、単なる「軽量モデル使用」ではなく、**独立したコンテキストウィンドウの活用**にあります。

通常の MCP クライアントの場合：
```
メインエージェント（Sonnet）のコンテキスト
  ↓ ツール定義が全部ロード
  ↓ ファイル内容も直接ロード
  ↓ コンテキストが飽和
```

Explore サブエージェント使用時：
```
メインエージェント（Sonnet）のコンテキスト：高レベルタスク管理に専念
  ↓
Explore サブエージェント（Haiku）の独立コンテキスト：コードベース検索
  ↓ 必要な情報だけをメインに返す
  ↓ メインはスッキリしたコンテキストで意思決定
```

メイン側は、Explore から受け取った要点だけを使用するため、**中間ファイル全体がメインのコンテキストを通る必要がありません**。これが、前回の記事で触れた「50,000トークンの削減」実現の鍵です。

## Plan サブエージェント

### 導入背景と目的

Plan サブエージェントは v2.0.28（2025年11月）で導入されました[^2]。その目的は、**Plan モード中に専用の分析・計画機能を提供すること**です。

Plan モード自体は、「実行前の調査・検証」を支援する機能です。しかし、十分な調査なしに計画を立てると、後の実行フェーズで手戻りが発生します。Plan サブエージェントは、「計画段階での深い分析」を担当します。

### Sonnet による分析能力

Plan サブエージェントは、**Sonnet モデルで駆動**されています[^2]。これは Explore サブエージェントの Haiku とは異なる選択です。

なぜ Sonnet なのか？

- **計画タスクの複雑性**: ファイル検索（Explore）と異なり、計画は複数の情報を統合し、トレードオフを判断する必要があります
- **コード分析の深さ**: 実装の可能性、潜在的な問題、ベストプラクティスを評価する必要があります
- **説明品質**: ユーザーに返す計画書の質が求められます

Sonnet は、これらの要求に見合う能力を持つ、コスト効率の良いモデルです。

### ツール・権限・制限

公式ドキュメントによると、Plan サブエージェントは以下のツールにアクセスできます[^2]：

- **Read**: ファイル内容の読取
- **Glob**: ファイルパターン検索
- **Grep**: テキスト検索
- **Bash**: コマンド実行

これらはすべて**読み取り・検索中心**です。ファイル編集やシステム状態の変更はできません。これは、Plan モード の「承認前に実行しない」という原則を担保するための設計です。

### エージェント無限ネストの防止

Plan モードの設計で注目すべき点が、**「サブエージェントは他のサブエージェントを生成できない」という制限**です[^2]。

なぜこの制限があるのか？

複雑なタスクに対して、エージェントが勝手にネストする場合を考えてください：

```
Plan サブエージェント
  ↓ 複雑な分析だと思って
  ↓ さらに別のサブエージェントを生成
  ↓ その子エージェントがさらに...
```

このように無限に深くなると、**トークン消費が爆発的に増加**し、ユーザーの意図が不透明になります。特に Plan モードは「確認してから実行」という慎重なモードなので、こういった自動化の過剰化は避けるべきです。

制限を入れることで、「Plan モード での意思決定は常に人間の目を通す」という原則が守られます。

## Explore と Plan の連携

### Planモード内でのExplore活用

Explore と Plan の連携は、特に **Plan モード**で顕著です。

**流れ：**

1. ユーザーが Plan モード（Shift+Tab×2）を有効化し、タスク指示を出す
2. Claude Code のメインエージェント（Sonnet）が、計画のための調査が必要と判断
3. 自動的に Explore サブエージェント（Haiku）が起動
4. Explore が効率的にコードベースを探索
5. Explore の成果をメインに返す
6. メイン（Plan サブエージェント経由で Sonnet）が、その情報をもとに計画を立案
7. 構造化された計画がユーザーに提示される

ここで重要なのは、**Explore の出力がメインのコンテキストを圧迫しない**ということです。Explore が見つけた情報は要点に集約されて返されるため、メインは整理されたコンテキストで計画に専念できます。

### モデル選択の戦略

Explore（Haiku）と Plan（Sonnet）の両者を組み合わせることで、**モデルの適切な使い分け戦略**が実現されています：

| タスク | モデル | 理由 |
|--------|--------|------|
| コードベース検索・分析 | Haiku | 高速・低コスト・十分な精度 |
| 情報統合・計画立案 | Sonnet | 複雑な判断・高品質な説明 |

もし、すべてを Sonnet で行えば、精度は高いかもしれません。しかし、トークン消費が増加し、コストが上昇します。逆に、すべてを Haiku で行えば、コストは下がりますが、複雑な計画は立てられません。

**両者を目的に応じて使い分ける**——これが、AI エージェント の現実的な運用です。

## 実践 Tips

### Plan モードの活用ワークフロー

Explore と Plan の仕組みを理解すれば、以下のワークフローが有効です：

1. **複雑な機能追加を計画する時**
   - Plan モード（Shift+Tab×2）で、「〇〇機能を追加してほしい」と指示
   - Explore が自動的にコードベースを調査
   - Plan が詳細な実装計画を立案
   - 計画を確認してから、実行モードで実装開始

2. **既存コードの改善提案を得たい時**
   - 「パフォーマンス改善の提案をしてほしい」と Plan モードで指示
   - Explore がファイル全体をスキャン
   - Plan が改善案を構造化して提示
   - トークン無駄なく、正確な提案を得る

3. **バグの原因調査をしたい時**
   - エラーメッセージと「どうしてこのエラーが起きているのか調査して」を Plan モードで提示
   - Explore が関連ファイルを自動検索
   - Plan が原因を特定
   - ユーザーが修正方針を判断

### コンテキスト効率化のベストプラクティス

Explore と Plan の仕組みを活用するには：

1. **Plan モードを活用する**
   - 安易に実行モードで指示するのではなく、複雑なタスクは Plan モードで検討
   - 計画の品質が上がり、実装の手戻りが減る

2. **自動委任を信頼する**
   - Explore/Plan が必要なら、Claude Code が自動的に判断します
   - ユーザーが明示的に指示する必要はありません

3. **カスタムサブエージェント設計への示唆**
   - 必要に応じてカスタムサブエージェントを作るなら、「役割分担」と「適切なモデル選択」の原則は同じ
   - 単純なタスク → 軽いモデル、複雑なタスク → 高度なモデル、という設計が有効

## まとめ

Claude Code に搭載されている Explore と Plan サブエージェントは、多くのユーザーが意識しないまま活用しています。しかし、その仕組みを理解することで、より**効率的で意図的な使い方**ができます。

**主な学習ポイント：**

- **Explore（v2.0.17、Haiku駆動）**: 高速・低コストなコードベース探索を実現。Plan モード中の調査フェーズで自動起動
- **Plan（v2.0.28、Sonnet駆動）**: 複雑な計画立案に特化。Explore との連携で、コンテキスト効率を保ちながら深い分析を実行
- **モデルの使い分け**: 必要な能力だけを選択的に用いる、という設計思想は、前回の記事で触れた「MCP のオンデマンドツール読み込み」と一貫しています

実は、Claude Code のサブエージェント機構全体は、MCPの課題に対する**実装レベルでの回答**です。MCPのコンテキスト圧迫問題は、内部的には「適切なエージェント委譲」で解決されています。

これから Claude Code を使うなら、こうした背景を知った上で、Plan モードを活用し、複雑なタスク分析をサブエージェントに任せる——そういう使い方が、最も効率的です。

[^1]: ClaudeLog: "Explore Subagent (v2.0.17) as a Haiku-powered codebase search specialist for context-efficient exploration." 出典: [ClaudeLog: Sub-agents](https://claudelog.com/mechanics/sub-agents/)

[^2]: Claude Code公式ドキュメント: "Plan サブエージェントを使用してコードベースに関する調査を実施"、"エージェントの無限ネストを防ぎます（サブエージェントは他のサブエージェントを生成できません）"、"Read、Glob、Grep、Bash へのアクセス権"。出典: [Claude Code: Sub-agents](https://code.claude.com/docs/ja/sub-agents)

---

## 参考

- [Claude Code: Sub-agents](https://code.claude.com/docs/ja/sub-agents) - ビルトインサブエージェントと Plan モードの公式ドキュメント
- [ClaudeLog: Sub-agents](https://claudelog.com/mechanics/sub-agents/) - Explore と Plan サブエージェントの技術詳解
- [ClaudeLog: Plan Mode](https://claudelog.com/mechanics/plan-mode/) - Plan モードの仕組みと Explore 連携の解説
